#cloud-config
hostname: ${hostname}

users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: [users, admin, docker]
    shell: /bin/bash
    ssh-authorized-keys:
      - ${ssh_key}
    lock_passwd: false
    passwd: $6$rounds=656000$devops$devops123

# Установка базовых пакетов
packages:
  - qemu-guest-agent
  - curl
  - wget
  - git
  - vim
  - htop
  - net-tools
  - tree
  - unzip
  - software-properties-common
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release

# Настройка репозиториев
runcmd:
  # Обновление системы
  - apt update && apt upgrade -y
  
  # Установка Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt update
  - apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  
  # Добавление пользователя в группу docker
  - usermod -aG docker ubuntu
  
  # Включение и запуск сервисов
  - systemctl enable --now qemu-guest-agent
  - systemctl enable --now docker
  
  # Настройка Docker daemon
  - mkdir -p /etc/docker
  - echo '{"log-driver": "json-file","log-opts": {"max-size": "10m","max-file": "3"}}' > /etc/docker/daemon.json
  - systemctl restart docker
  
  # Создание директорий для DevOps Lab
  - mkdir -p /opt/devops-lab/{scripts,configs,logs}
  - chown -R ubuntu:ubuntu /opt/devops-lab
  
  # Настройка мониторинга системы
  - echo '*/5 * * * * root /usr/bin/df -h >> /var/log/disk-usage.log' | crontab -
  
  # Настройка SSH
  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - systemctl restart ssh
  
  # Настройка firewall (если включен)
  - ufw --force enable
  - ufw allow ssh
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 6443/tcp
  - ufw allow 8080/tcp
  - ufw allow 9090/tcp
  - ufw allow 3000/tcp
  - ufw allow 9200/tcp
  - ufw allow 5601/tcp
  
  # Создание файла с информацией о системе
  - echo "Hostname: ${hostname}" > /opt/devops-lab/system-info.txt
  - echo "Tags: ${tags_string}" >> /opt/devops-lab/system-info.txt
  - echo "Created: $(date)" >> /opt/devops-lab/system-info.txt
  - echo "IP: $(hostname -I | awk '{print $1}')" >> /opt/devops-lab/system-info.txt
  
  # Настройка мониторинга логов
  - echo '*.log { rotate 7 daily missingok notifempty compress delaycompress }' > /etc/logrotate.d/devops-lab
  
  # Создание alias'ов для удобства
  - echo 'alias ll="ls -la"' >> /home/ubuntu/.bashrc
  - echo 'alias k="kubectl"' >> /home/ubuntu/.bashrc
  - echo 'alias d="docker"' >> /home/ubuntu/.bashrc
  - echo 'alias dc="docker-compose"' >> /home/ubuntu/.bashrc
  
  # Настройка цветного вывода для команд
  - echo 'export PS1="\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /home/ubuntu/.bashrc
  
  # Установка прав на .bashrc
  - chown ubuntu:ubuntu /home/ubuntu/.bashrc

# Настройка timezone
timezone: Europe/Moscow

# Настройка locale
locale: en_US.UTF-8

# Настройка keyboard
keyboard:
  layout: us

# Настройка network
network:
  version: 2
  ethernets:
    ens192:
      dhcp4: true
      dhcp4-overrides:
        route-metric: 100

# Настройка mounts (если нужно)
mounts:
  - [ /dev/sdb, /opt/data, auto, "defaults,nofail", "0", "2" ]

# Настройка power management
power_state:
  mode: reboot
  timeout: 30
  condition: true
